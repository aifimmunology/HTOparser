---
title: "Cell Hashing HTO count processing"
author:
- Lucas Graybuck
- Richard Green
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    self_contained: true
params:
  in_type: "no_params"
  in_file: NULL
  in_key: NULL
  out_mat: NULL
  out_tbl: NULL
---

<a id="contents"></a>

## Contents

#### [Data Processing](#data_processing)
- [Session Preparation](#session_preparation)
- [Load Inputs](#load_inputs)
- [Process HTO Data](#process data)
- [Write Outputs](#data_output)

#### [QC Metrics and Plots](#qc_metrics)
- [Raw Count Summary](#hash_count_summary)
- [HTO Count Distributions](#hash_hist_plot)
- [HTO Category Summary](#cat_summary)
- [Sample/HTO Singlet Counts](#singlet_counts)
- [Sample/HTO Singlet Plot](#singlet_plot)

#### [Session Info](#session_info)

<a id="data_processing"></a>

## Data Processing

<a id="session_preparation"></a>

### Session Preparation

#### Load libraries:
```{r Load Libraries}
start_time <- Sys.time()

quiet_library <- function(...) {
  suppressPackageStartupMessages(library(...))
}
quiet_library(HTOparser)
quiet_library(H5weaver)
quiet_library(ggplot2)
quiet_library(cowplot)
```

Declaring start
```{r Declare Start}
stm("Starting HTO count processing")
```

#### Argument parsing
```{r Parse Arguments}
if(params$in_type == "no_params") {
  in_type <- "test_cite"
} else {
  in_type <- match.arg(params$in_type, choices = c("awk","cite","test_awk","test_cite"))
}

if(in_type == "test_awk") {
  in_type <- "awk"
  in_file <- system.file("testdata/awk_pipeline_counts_table.csv.gz", package = "HTOparser")
  in_key  <- system.file("reference/SampleSheet_fallback.csv", package = "HTOparser")
  out_mat <- tempfile(fileext = ".csv")
  out_tbl <- tempfile(fileext = ".csv")
} else if(in_type == "test_cite-old") {
  in_type <- "cite-old"
  in_file <- system.file("testdata/CITE-seq_count_matrix.csv.gz", package = "HTOparser")
  in_key  <- system.file("reference/SampleSheet_fallback.csv", package = "HTOparser")
  out_mat <- tempfile(fileext = ".csv")
  out_tbl <- tempfile(fileext = ".csv")
} else if(in_type == "test_cite") {
  in_type <- "cite"
  in_file <- system.file("testdata/CITE-seq-Count_umi_mtx/", package = "HTOparser")
  in_key <- system.file("reference/SampleSheet_fallback.csv", package = "HTOparser")
  out_mat <- tempfile(fileext = ".csv")
  out_tbl <- tempfile(fileext = ".csv")
} else {
  in_file <- params$in_file
  in_key  <- params$in_key
  out_mat <- params$out_mat
  out_tbl <- params$out_tbl
}

stm(paste0("IN  HTO count type   : ", in_type))
stm(paste0("IN  HTO count file   : ", in_file))
stm(paste0("IN  HTO sample sheet : ", in_key))
stm(paste0("OUT Count matrix     : ", out_mat))
stm(paste0("OUT Category table   : ", out_tbl))
```

```{r Print arguments}
print(c(
  paste0("IN  HTO count type   : ", in_type),
  paste0("IN  HTO count file   : ", in_file),
  paste0("IN  HTO sample sheet : ", in_key),
  paste0("OUT Count matrix     : ", out_mat),
  paste0("OUT Category table   : ", out_tbl)
))
```

[Return to Contents](#contents)

<a id="load_inputs"></a>

### Load Input Datasets

#### HTO reference
```{r Load HTO Reference, echo = FALSE, results = 'asis'}
hto_ref <- totalseq_a_human()
hto_key <- system.file("reference/TotalSeqA_human_hto_key.csv", package = "HTOparser")

qc_table(hto_ref)
```

#### Read input table/matrix and barcode key
```{r Read Input Files}
if(in_type %in% c("awk","cite-old")) {
  in_hto_table <- fread(in_file)
} else if(in_type == "cite") {
  in_dir <- file.path(in_file, "umi_count/")
  in_hto_table <- read_csc_mtx(in_dir)
  in_hto_table <- in_hto_table[rownames(in_hto_table) != "unmapped",]
  rownames(in_hto_table) <- sub("-.+","",rownames(in_hto_table))
}
in_hto_ss <- fread(in_key, col.names = c("pbmc_sample_id","batch_id","hto_name","pool_id"))
in_hto_key <- fread(hto_key, header = FALSE, col.names = c("hto_barcode","hto_name"))
in_hto_key <- in_hto_key[in_hto_ss, on = "hto_name"]
```

#### Sample Sheet
```{r}
qc_table(in_hto_ss)
```

[Return to Contents](#contents)

<a id="process_data"></a>

### Process HTO Counts

#### Convert input data to matrix
```{r}
if(in_type == "awk") {
  stm("Filtering input HTO table for valid barcodes")
  names(in_hto_table) <- c("count","cell_barcode","hto_barcode")
  in_hto_table <- fuzzy_filtering(in_hto_table,
                                  match_column = "hto_barcode",
                                  match_values = hto_ref$hto_barcode,
                                  max_distance = 1)
  
  stm("Converting HTO table to matrix")
  in_hto_mat <- barcode_table_to_matrix(in_hto_table,
                                        valid_htos = hto_ref$hto_barcode)
} else if(in_type == "cite-old") {
  stm("Formatting HTO matrix and filtering for valid barcodes")
  in_hto_mat <- as.matrix(in_hto_table[,-1])
  in_hto_mat <- as(in_hto_mat, "dgCMatrix")
  rownames(in_hto_mat) <- in_hto_key$hto_barcode[match(in_hto_table[[1]], in_hto_key$hto_name)]
} else if(in_type == "cite") {
  stm("Formatting HTO matrix and filtering for valid barcodes")
  in_hto_mat <- as(in_hto_table, "dgCMatrix")
  rownames(in_hto_mat) <- in_hto_key$hto_barcode[match(rownames(in_hto_table), in_hto_key$hto_name)]
}
in_hto_mat <- add_missing_hto_rows(in_hto_mat,
                                   valid_htos = hto_ref$hto_barcode)
```

#### Call positive and negative HTOs
```{r Convert Matrix to Binary Calls}
stm("Binarizing HTO counts to call positive and negative hashes")
binary_results <- binarize_hash_matrix(in_hto_mat,
                                       valid_htos = hto_ref$hto_barcode,
                                       min_cut = 10,
                                       cutoff_vals = NULL)
```

#### Convert hashes to category calls
```{r Convert Binary Matrix to Categories}
stm("Converting binary results to categories")
category_results <- categorize_binary_hash_matrix(binary_results$bmat)
```

[Return to Contents](#contents)

<a id="data_output"></a>

### Write Outputs

#### Write count matrix
```{r Write Count Matrix}
stm(paste0("Writing count matrix to ", out_mat))
out_hto_mat <- as(in_hto_mat, "matrix")
out_hto_mat <- as.data.table(out_hto_mat)
out_hto_mat <- cbind(data.table(hto_barcode = rownames(in_hto_mat)),
                     out_hto_mat)
fwrite(out_hto_mat,
       file = out_mat)
```

#### Write category table
```{r Write Category Table}
stm(paste0("Writing category table to ", out_tbl))

hto_barcodes_to_pbmc_ids <- function(x,
                                     bc_key) {
  x <- as.character(x)
  res <- character()
  for(i in seq_along(x)) {
    bcs <- unlist(strsplit(x[i], ";")[[1]])
    res[i] <- paste(bc_key$pbmc_sample_id[match(bcs, bc_key$hto_barcode)],
                    collapse = ";")
  }
  res
}

hash_category_table <- category_results$hash_category_table
hash_category_table$pbmc_sample_id <- hto_barcodes_to_pbmc_ids(hash_category_table$hto_barcode,
                                                               in_hto_key)

rownames(hash_category_table) <- NULL
  
fwrite(hash_category_table,
       file = out_tbl)
```

[Return to Contents](#contents)

<a id="qc_metrics"></a>

## QC Tables and Plots

<a id="hash_count_summary"></a>

#### Hash Count Summary
```{r Print Hash Count Summary, echo = FALSE, results = 'asis'}
bsummary <- binary_results$bsummary
bsummary$pbmc_sample_id <- in_hto_key$pbmc_sample_id[match(bsummary$hto_barcode, in_hto_key$hto_barcode)]
bsummary <- setcolorder(bsummary,
                        c("pbmc_sample_id","hto_barcode",
                          "cutoff","n_pos","n_neg","n_below_threshold",
                          "frac_pos","frac_neg","frac_below_threshold"))
rownames(bsummary) <- NULL

qc_table(bsummary)
```

[Return to Contents](#contents)

<a id="hash_hist_plot"></a>

#### Generate plots
```{r Generate Distribution Plots}
stm("Generating plots for report")
plot_list <- lapply(
  1:nrow(hto_ref),
  function(x) {
    barcode <- hto_ref$hto_barcode[x]
    sample_id <- in_hto_key$pbmc_sample_id[in_hto_key$hto_barcode == barcode]
    vals <- in_hto_mat[barcode,]
    
    n_vals_below_min_cut <- sum(vals <= 10)
    vals_above_min_cut <- vals[vals > 10]
    
    if(length(vals_above_min_cut) > 0) {
      cutoff <- bsummary$cutoff[bsummary$hto_barcode == barcode]
      
      val_df <- data.frame(vals = log10(vals_above_min_cut))
      cut_df <- data.frame(cutoff = log10(cutoff))
      
      ggplot() +
        geom_histogram(data = val_df,
                     aes(x = vals),
                     fill = "darkgreen",
                     binwidth = 0.05) +
        geom_vline(data = cut_df,
                   aes(xintercept = cutoff),
                   size = 1,
                   color = "dodgerblue") +
        scale_x_continuous("log10(HTO Count)", 
                           limits = c(0,5)) +
        scale_fill_identity() +
        scale_color_identity() +
        ggtitle(paste(sample_id, "|", barcode)) +
        theme_bw(base_size = 8)
    } else {
      text_df <- data.frame(x = 2.5,
                            y = 0.5,
                            label = "Hash not detected")
      
      ggplot() +
        geom_text(data = text_df,
                  aes(x = x,
                      y = y,
                      label = label)) +
        scale_x_continuous("log10(HTO Count)", 
                           limits = c(0,5)) +
        scale_y_continuous("count",
                           limits = c(0,1)) +
        ggtitle(paste(sample_id, "|", barcode)) +
        theme_bw(base_size = 8)
    }
  }
)
```

#### Hash Count Distribution Plots
```{r Display Plots, fig.height = 12, fig.width = 12}
suppressWarnings(
  plot_grid(plotlist = plot_list,
            nrow = ceiling(length(plot_list) / 2),
            ncol = 2)
)
```

[Return to Contents](#contents)

<a id="cat_summary"></a>

#### Hash Category Summary
```{r Display Category Summary, echo = FALSE, results = 'asis'}
rownames(category_results$hash_summary) <- NULL

qc_table(category_results$hash_summary)
```

[Return to Contents](#contents)

<a id="singlet_counts"></a>

### Sample/HTO Singlet Counts
```{r Count Singlets Per Hash}
singlet_summary <- make_singlet_summary(category_results$hash_category_table,
                                        valid_htos = hto_ref$hto_barcode)
singlet_summary$pbmc_sample_id <- in_hto_key$pbmc_sample_id[match(singlet_summary$hto_barcode, in_hto_key$hto_barcode)]
singlet_summary <- setcolorder(singlet_summary,
                               c("pbmc_sample_id",
                                 "hto_barcode",
                                 "n_singlets",
                                 "frac_singlets"))

qc_table(singlet_summary)
```

[Return to Contents](#contents)

<a id="singlet_plot"></a>

### Sample/HTO Singlet Counts Plot
```{r Plot Singlet Counts}
singlet_plot_data <- singlet_summary
singlet_plot_data$x <- 1:nrow(singlet_summary)

ggplot() +
  geom_rect(data = singlet_plot_data,
            aes(xmin = x - 0.4, xmax = x + 0.4,
                ymin = 0, ymax = n_singlets)) +
  geom_text(data = singlet_plot_data,
            aes(x = x,
                y = n_singlets * 1.02,
                label = n_singlets),
            vjust = 0,
            size = 3) +
  ggtitle("Singlet Counts") +
  scale_x_continuous("",
                     breaks = singlet_plot_data$x,
                     labels = paste0(singlet_plot_data$hto_barcode,
                                     "\n",
                                     singlet_plot_data$pbmc_sample_id)) +
  scale_y_continuous("N Singlets") +
  theme_bw(base_size = 8) +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.3))

```

[Return to Contents](#contents)

<a id="session_info"></a>

## Session Information

```{r Report Session Info}
sessionInfo()
```

Total time elapsed
```{r}
end_time <- Sys.time()
diff_time <- end_time - start_time
time_message <- paste0("Elapsed Time: ", 
                       round(diff_time, 3),
                       " ", units(diff_time))
print(time_message)
stm(time_message)
stm("HTO count processing complete.")
```

[Return to Contents](#contents)

